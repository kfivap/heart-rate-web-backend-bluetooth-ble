<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Å—Ç –ø—É–ª—å—Å–æ–º–µ—Ç—Ä–∞ —á–µ—Ä–µ–∑ Web Bluetooth</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background-color: #f5f5f5;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, button { 
      margin: 5px; 
      padding: 8px; 
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    .user-list { margin-top: 20px; }
    .user-item { 
      background: #f8f9fa; 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 8px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      border-left: 4px solid #007bff;
    }
    .error { 
      background: #ffebee; 
      color: #c62828; 
      padding: 10px; 
      border-radius: 5px; 
      margin: 10px 0; 
    }
    .success { 
      background: #e8f5e8; 
      color: #2e7d32; 
      padding: 10px; 
      border-radius: 5px; 
      margin: 10px 0; 
    }
    .chart-container { 
      margin: 20px 0; 
      background: white; 
      padding: 20px; 
      border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    .chart-title { 
      font-size: 18px; 
      font-weight: bold; 
      margin-bottom: 15px; 
      color: #333;
      text-align: center;
    }
    .chart-wrapper {
      position: relative;
      height: 400px;
      width: 100%;
    }
    .user-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .chart-section {
      margin-top: 30px;
    }
    .no-data {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .close-chart {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 16px;
    }
    .close-chart:hover {
      background: #c82333;
    }
    .auto-update-indicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #28a745;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }
    .auto-update-indicator.disabled {
      background: #6c757d;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ù§Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—É–ª—å—Å–∞</h1>
    
    <div>
      <input type="text" id="userName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" />
      <button id="connect">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –ø—É–ª—å—Å–æ–º–µ—Ç—Ä</button>
    </div>
    
    <p id="status">‚è≥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</p>
    <p id="pulse">‚ù§Ô∏è –ü—É–ª—å—Å: ---</p>
    
    <div id="apiStatus"></div>
    
    <div class="user-list">
      <h3>üìä –î–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</h3>
      <div id="usersList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="chart-section">
      <h3>üìà –ì—Ä–∞—Ñ–∏–∫–∏ –ø—É–ª—å—Å–∞</h3>
      <div id="chartsContainer">
        <div class="no-data">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞</div>
      </div>
    </div>
  </div>

  <script>
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL API
    const getApiUrl = () => {
      return '/api'
    };
    
    const API_URL = getApiUrl();
    let currentHeartRate = null;
    let userName = '';
    let charts = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    let currentChartUser = null; // –¢–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π –≥—Ä–∞—Ñ–∏–∫
    let chartUpdateInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
    async function checkApiStatus() {
      try {
        const response = await fetch(`${API_URL}/health`, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (response.ok) {
          document.getElementById('apiStatus').innerHTML = 
            '<div class="success">‚úÖ API —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω</div>';
          return true;
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API:', err);
        
        let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API —Å–µ—Ä–≤–µ—Ä—É';
        document.getElementById('apiStatus').innerHTML = 
          `<div class="error">${errorMessage}</div>`;
        return false;
      }
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    async function loadUsers() {
      try {
        const response = await fetch(`${API_URL}/users`, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const users = await response.json();
        
        const usersList = document.getElementById('usersList');
        if (Object.keys(users).length === 0) {
          usersList.innerHTML = '–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—É–ª—å—Å–µ';
          return;
        }
        
        usersList.innerHTML = Object.values(users)
          .map(user => `
            <div class="user-item">
              <div>
                <strong>${user.name}</strong>: ${user.lastHeartRate || '---'} —É–¥/–º–∏–Ω 
                <small>(${user.lastUpdate ? new Date(user.lastUpdate).toLocaleString() : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'})</small>
              </div>
              <div class="user-controls">
                <button onclick="showChart('${user.name}')">üìà –ì—Ä–∞—Ñ–∏–∫</button>
                <button onclick="showChart('${user.name}', 100)">üìä –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</button>
                <button onclick="closeChart()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
            </div>
          `).join('');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err);
        document.getElementById('usersList').innerHTML = 
          '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.</div>';
      }
    }

    // –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
    function startChartAutoUpdate() {
      if (chartUpdateInterval) {
        clearInterval(chartUpdateInterval);
      }
      
      chartUpdateInterval = setInterval(() => {
        if (currentChartUser) {
          updateChart(currentChartUser);
          console.log(`üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è ${currentChartUser}`);
        }
      }, 10000); // –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
      
      console.log('‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞–ø—É—â–µ–Ω–æ (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫)');
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
    function stopChartAutoUpdate() {
      if (chartUpdateInterval) {
        clearInterval(chartUpdateInterval);
        chartUpdateInterval = null;
        console.log('‚èπÔ∏è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      }
    }

    // –ó–∞–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫
    function closeChart() {
      if (currentChartUser && charts[currentChartUser]) {
        charts[currentChartUser].destroy();
        delete charts[currentChartUser];
      }
      currentChartUser = null;
      stopChartAutoUpdate(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      document.getElementById('chartsContainer').innerHTML = 
        '<div class="no-data">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞</div>';
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø—É–ª—å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function showChart(userName, limit = 50) {
      try {
        const response = await fetch(`${API_URL}/users/${encodeURIComponent(userName)}/history?limit=${limit}`, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.history || data.history.length === 0) {
          document.getElementById('chartsContainer').innerHTML = 
            `<div class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userName}</div>`;
          return;
        }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        closeChart();

        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const labels = data.history.map(item => 
          new Date(item.timestamp).toLocaleTimeString()
        );
        const heartRates = data.history.map(item => item.heartRate);

        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const chartContainer = document.createElement('div');
        chartContainer.className = 'chart-container';
        chartContainer.innerHTML = `
          <div class="auto-update-indicator" id="autoUpdateIndicator">üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
          <button class="close-chart" onclick="closeChart()">√ó</button>
          <div class="chart-title">üìà –ì—Ä–∞—Ñ–∏–∫ –ø—É–ª—å—Å–∞: ${userName} (${data.count} –∏–∑–º–µ—Ä–µ–Ω–∏–π)</div>
          <div class="chart-wrapper">
            <canvas id="chart-${userName}"></canvas>
          </div>
        `;

        document.getElementById('chartsContainer').innerHTML = '';
        document.getElementById('chartsContainer').appendChild(chartContainer);

        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
        const ctx = document.getElementById(`chart-${userName}`).getContext('2d');
        charts[userName] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: '–ü—É–ª—å—Å (—É–¥/–º–∏–Ω)',
              data: heartRates,
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            scales: {
              y: {
                beginAtZero: false,
                min: Math.max(40, Math.min(...heartRates) - 10),
                max: Math.min(200, Math.max(...heartRates) + 10),
                title: {
                  display: true,
                  text: '–ü—É–ª—å—Å (—É–¥/–º–∏–Ω)'
                },
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                }
              },
              x: {
                title: {
                  display: true,
                  text: '–í—Ä–µ–º—è'
                },
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                }
              }
            },
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `–ü—É–ª—å—Å: ${context.parsed.y} —É–¥/–º–∏–Ω`;
                  },
                  title: function(context) {
                    return `–í—Ä–µ–º—è: ${context[0].label}`;
                  }
                }
              }
            }
          }
        });

        currentChartUser = userName;
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        startChartAutoUpdate();

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err);
        document.getElementById('chartsContainer').innerHTML = 
          `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è ${userName}</div>`;
      }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    async function updateChart(userName) {
      if (!currentChartUser || currentChartUser !== userName) {
        return; // –ì—Ä–∞—Ñ–∏–∫ –Ω–µ –æ—Ç–∫—Ä—ã—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      }

      try {
        const response = await fetch(`${API_URL}/users/${encodeURIComponent(userName)}/history?limit=50`, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        if (!response.ok) {
          return;
        }
        
        const data = await response.json();
        
        if (!data.history || data.history.length === 0) {
          return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
        const labels = data.history.map(item => 
          new Date(item.timestamp).toLocaleTimeString()
        );
        const heartRates = data.history.map(item => item.heartRate);

        charts[userName].data.labels = labels;
        charts[userName].data.datasets[0].data = heartRates;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—à—Ç–∞–±
        charts[userName].options.scales.y.min = Math.max(40, Math.min(...heartRates) - 10);
        charts[userName].options.scales.y.max = Math.min(200, Math.max(...heartRates) + 10);
        
        charts[userName].update('none'); // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏–∑–º–µ—Ä–µ–Ω–∏–π
        const chartTitle = document.querySelector('.chart-title');
        if (chartTitle) {
          chartTitle.textContent = `üìà –ì—Ä–∞—Ñ–∏–∫ –ø—É–ª—å—Å–∞: ${userName} (${data.count} –∏–∑–º–µ—Ä–µ–Ω–∏–π)`;
        }

        console.log(`üìä –ì—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω: ${data.count} –∏–∑–º–µ—Ä–µ–Ω–∏–π`);

      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞:', err);
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—É–ª—å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function saveHeartRate(name, heartRate) {
      try {
        const response = await fetch(`${API_URL}/heart-rate`, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name, heartRate })
        });
        
        if (response.ok) {
          console.log('–ü—É–ª—å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', name, heartRate);
          loadUsers(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          updateChart(name);
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
      }
    }

    async function connectHeartRate() {
      userName = document.getElementById('userName').value.trim();
      if (!userName) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
        return;
      }

      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['heart_rate'] }]
        });

        document.getElementById("status").textContent = "üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('heart_rate');
        const characteristic = await service.getCharacteristic('heart_rate_measurement');

        characteristic.addEventListener('characteristicvaluechanged', event => {
          const value = event.target.value;
          const flags = value.getUint8(0);
          let heartRate;
          if (flags & 0x01) {
            heartRate = value.getUint16(1, true);
          } else {
            heartRate = value.getUint8(1);
          }
          
          currentHeartRate = heartRate;
          document.getElementById("pulse").textContent = `‚ù§Ô∏è –ü—É–ª—å—Å: ${heartRate} —É–¥/–º–∏–Ω`;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É–ª—å—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          saveHeartRate(userName, heartRate);
          
          console.log("Pulse:", heartRate);
        });

        await characteristic.startNotifications();
        document.getElementById("status").textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ " + device.name;

      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "‚ùå –û—à–∏–±–∫–∞: " + err;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.getElementById("connect").addEventListener("click", connectHeartRate);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º API –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    checkApiStatus().then(apiOk => {
      if (apiOk) {
        loadUsers();
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(loadUsers, 5000);
      }
    });
  </script>
</body>
</html>
